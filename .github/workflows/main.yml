name: üöÄ Deploy website on push
on:
  push:

jobs:
  web-deploy:
    runs-on: ubuntu-latest
    env:
      FRONT_DIR: QuaiAntiqueRestaurantFront

    steps:
      - name: üì• Download repo as ZIP (no git, no submodules)
        run: |
          set -e
          curl -sSL \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            -o repo.zip \
            "https://api.github.com/repos/${{ github.repository }}/zipball/${{ github.sha }}"
          unzip -q repo.zip
          topdir="$(ls -d */ | head -n 1)"
          rm -rf "$FRONT_DIR"
          mv "$topdir/$FRONT_DIR" "./$FRONT_DIR"
          rm -rf "$topdir" repo.zip
          ls -la "$FRONT_DIR" || true

      - name: üü¢ Setup Node (only if package.json exists)
        if: ${{ hashFiles('QuaiAntiqueRestaurantFront/package.json') != '' }}
        uses: actions/setup-node@v5
        with:
          node-version: 20

      - name: üì¶ Install npm deps
        if: ${{ hashFiles('QuaiAntiqueRestaurantFront/package.json') != '' }}
        working-directory: ${{ env.FRONT_DIR }}
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi

      - name: üèóÔ∏è Build (optional)
        if: ${{ hashFiles('QuaiAntiqueRestaurantFront/package.json') != '' }}
        working-directory: ${{ env.FRONT_DIR }}
        run: |
          if npm run | grep -q " build"; then
            npm run build
          else
            echo "No build script found. Skipping."
          fi

      - name: üìÇ Sync files (FTPS implicite)
        uses: SamKirkland/FTP-Deploy-Action@v4.3.6
        with:
          server: ftp-lerestaurantquaiantique.alwaysdata.net
          username: lerestaurantquaiantique
          password: ${{ secrets.ftp_password }}
          protocol: ftps-legacy
          port: 990
          security: strict
          timeout: 120000
          local-dir: ${{ env.FRONT_DIR }}/
          server-dir: /www/
          exclude: |
            **/.git*
            **/.git*/**
            **/node_modules/**
